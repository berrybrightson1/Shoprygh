generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- Multi-Tenancy Core ---

model Store {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  tier        StoreTier @default(HUSTLER)
  ownerPhone  String?
  
  // Profile Information
  logo        String?   // URL to logo image
  description String?   // Store bio/description
  address     String?   // Physical business address
  
  // Account Status
  status           StoreStatus @default(ACTIVE)
  suspensionReason String?
  suspendedAt      DateTime?
  termsAcceptedAt  DateTime?

  // Verification (Ghana Pro)
  isVerified       Boolean            @default(false)
  kycDocumentUrl   String?
  verificationStatus VerificationStatus @default(PENDING)
  deliveryZones    DeliveryZone[]
  
  users       User[]
  products    Product[]
  orders      Order[]
  subscriptions Subscription[]
  

  // Finance
  walletBalance Decimal @default(0)
  payouts     PayoutRequest[]
  transactions WalletTransaction[]

  // Marketing
  coupons     Coupon[]
  
  // CRM
  customers   Customer[]
  customerReports CustomerReport[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- CRM Models ---

model Customer {
  id          String   @id @default(cuid())
  name        String?
  email       String?
  phone       String?
  
  totalSpent  Decimal  @default(0)
  totalOrders Int      @default(0)
  lastOrderAt DateTime?
  
  notes       String?  @db.Text
  
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  orders      Order[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([storeId, phone]) // Unique customer per store by phone
  @@unique([storeId, email]) // Unique customer per store by email

  // Trust & Safety
  isVerified      Boolean  @default(false)
  otpCode         String?
  otpExpiresAt    DateTime?
  trustScore      Int      @default(100)
  status          String   @default("ACTIVE") // ACTIVE, RESTRICTED, BANNED
  reports         CustomerReport[]
}

// --- Marketing Models ---

model Coupon {
  id          String   @id @default(cuid())
  code        String   // e.g., "SUMMER10"
  type        String   @default("PERCENTAGE") // PERCENTAGE, FIXED
  value       Decimal
  
  uses        Int      @default(0)
  maxUses     Int?     // If null, unlimited
  expiresAt   DateTime?
  isActive    Boolean  @default(true)
  
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([storeId, code]) // Code must be unique per store
}

// --- Finance Models ---

model PayoutRequest {
  id          String   @id @default(cuid())
  amount      Decimal
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  // Payout Details
  method      String   // "Mobile Money", "Bank Transfer"
  destination String   // Phone number or Account Number
  
  // Admin Logic
  processedAt DateTime?
  adminNote   String?  // Why it was rejected/approved
  
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WalletTransaction {
  id          String   @id @default(cuid())
  amount      Decimal
  type        String   // SALE, Payout, REFUND, FEE
  description String
  
  referenceId String?  // ID of related Order or Payout
  
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
}

model SystemUpdate {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  version   String
  type      String   @default("UPDATE") // UPDATE, ALERT, MAINTENANCE
  createdAt DateTime @default(now())
}

// --- Application Models ---

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed
  name      String
  image     String?  // Avatar URL
  role      String   @default("STAFF") // "OWNER" | "STAFF"
  isPlatformAdmin Boolean @default(false)
  
  // Optional - Platform Admins don't need a store
  storeId   String?
  store     Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  auditLogs AuditLog[]

  createdAt DateTime @default(now())

  // Trust & Safety
  phone           String?  @unique // Optional for existing, unique for new
  isVerified      Boolean  @default(false)
  otpCode         String?
  otpExpiresAt    DateTime?
}

model AuditLog {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  action      String   // e.g., "LOGIN", "UPDATED_PROFILE"
  description String?
  metadata    Json?    // Old values, IP, etc.
  
  entityId    String?  // ID of affected item
  entityType  String?  // STORE, PRODUCT, ORDER
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Product {
  id             String   @id @default(cuid())
  name           String
  description    String?
  image          String?
  gallery        String[]  // Multiple images support

  // Pricing
  priceRetail    Decimal
  priceWholesale Decimal?
  costPrice      Decimal?  @default(0.00) // Profit Calculation (Ghana Pro)
  
  // Logistics
  sku            String?
  weight         Float?
  dimensions     String?
  
  // Organization
  category       String   @default("General")
  tags           String[] // Changed from String? to String[] for better filtering
  stockQty       Int      @default(0)
  
  // Variants
  variants       ProductVariant[]
  
  // Bundle Logic
  isBundle       Boolean  @default(false)
  bundleItems    BundleItem[] @relation("ParentBundle")

  // Lifecycle
  isArchived     Boolean  @default(false)
  
  // Tenancy
  storeId        String
  store          Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime @default(now())
  orderItems     OrderItem[]
}

model ProductVariant {
  id             String   @id @default(cuid())
  
  productId      String
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  name           String   // e.g. "Size: L, Color: Red"
  price          Decimal? // Optional override
  stockQty       Int      @default(0)
  sku            String?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model BundleItem {
  id        String  @id @default(cuid())
  
  bundleId  String
  bundle    Product @relation("ParentBundle", fields: [bundleId], references: [id], onDelete: Cascade)
  
  productId String  
  
  quantity  Int     @default(1)
}

model Order {
  id        String      @id @default(cuid())
  status    String      @default("PENDING") // PENDING, PAID, DELIVERED, CANCELLED
  customerName String?
  customerPhone String?
  
  // CRM Link (Optional for now, populated on checkout)
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])
  
  total     Decimal
  items     OrderItem[]
  
  // Tenancy
  storeId   String
  store     Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product @relation(fields: [productId], references: [id])
  
  name      String  // Snapshot in case product changes
  quantity  Int
  price     Decimal // Price at time of purchase
}

model Subscription {
  id                  String   @id @default(cuid())
  storeId             String
  store               Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  tier                StoreTier
  status              SubscriptionStatus @default(ACTIVE)
  
  currentPeriodStart  DateTime
  currentPeriodEnd    DateTime
  
  paymentMethod       String?  // e.g., "Paystack", "Mobile Money"
  paymentReference    String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

enum StoreStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
}

enum StoreTier {
  HUSTLER
  PRO
  WHOLESALER
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

// --- Logistics Models ---

model DeliveryZone {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  name        String   // e.g., "East Legon"
  fee         Decimal
  description String?
  createdAt   DateTime @default(now())
}

model CustomerReport {
  id          String   @id @default(cuid())
  
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  reason      String   // "Fake Payment", "Refused Delivery", "Abusive"
  createdAt   DateTime @default(now())

  @@unique([customerId, storeId]) // One report per store per customer
}
